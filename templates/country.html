<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{title}}</title>
	<link rel="stylesheet" href="/css/foundation.css">
	<link rel="stylesheet" href="/css/custom.css">
</head>
<body>
	<header class="top-bar">
		<div class="top-bar-right">
			<ul class="menu">
				<li><a href="/">Home</a></li>
				<li><a href="{{prevLink}}">Prev</a></li>
				<li><a href="{{nextLink}}">Next</a></li>
			</ul>
		</div>
	</header>
	<main class="grid-container">
		<h1 class="h2">{{pageTitle}}</h1>
		<div class="callout" style="display:flex; align-items:center; gap:16px;">
			<img id="flagImg" alt="Country flag" style="height:48px; width:auto; display:none; border-radius:4px;">
			<span id="flagCountryLabel" style="font-weight:600;"></span>
		</div>
		<table class="hover">
			<thead>
				<tr>
					<th>Year</th>
					<th>Freedom Index</th>
				</tr>
			</thead>
			<tbody>
				{{tableRows}}
			</tbody>
		</table>
		<section style="margin-top: 24px;">
			<canvas id="countryChart" height="120"></canvas>
		</section>
	</main>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
	(function(){
		try {
			var titleEl = document.querySelector('h1.h2');
			var titleText = (titleEl && titleEl.textContent) ? titleEl.textContent.trim() : '';
			var countryName = '';
			var m = titleText.match(/Freedom\s+Scores:\s*(.+)$/);
			if (m && m[1]) countryName = m[1].trim();
			// Stop at the first comma if present (e.g., "Hong Kong SAR, China" -> "Hong Kong SAR")
			countryName = countryName.split(',')[0].trim();
			if (!countryName) return;
			document.getElementById('flagCountryLabel').textContent = countryName;
			var encoded = encodeURIComponent(countryName);
			function setFlagFromData(data){
				if (!Array.isArray(data) || !data[0]) return false;
				var flags = data[0].flags || {};
				var src = flags.svg || flags.png || '';
				if (!src) return false;
				var img = document.getElementById('flagImg');
				img.src = src;
				img.style.display = 'inline-block';
				img.alt = (data[0].name && data[0].name.common ? data[0].name.common : countryName) + ' flag';
				return true;
			}
			fetch('https://restcountries.com/v3.1/name/' + encoded + '?fullText=true')
				.then(function(r){ return r.ok ? r.json() : Promise.reject(); })
				.then(function(data){ if (!setFlagFromData(data)) throw new Error('no flag'); })
				.catch(function(){
					return fetch('https://restcountries.com/v3.1/name/' + encoded)
						.then(function(r){ return r.ok ? r.json() : Promise.reject(); })
						.then(function(data){ if (!setFlagFromData(data)) throw new Error('no flag'); })
						.catch(function(){
							var img = document.getElementById('flagImg');
							img.src = 'https://countryflagsapi.com/png/' + encoded;
							img.style.display = 'inline-block';
							img.alt = countryName + ' flag';
						});
				});
		} catch(_) {}
	})();
	</script>
	<script type="application/json" id="countryLabels">{{chartLabels}}</script>
	<script type="application/json" id="countryValues">{{chartData}}</script>
	<script>
	(function() {
		function safeParse(id) {
			try {
				const el = document.getElementById(id);
				if (!el) return [];
				const txt = (el.textContent || '').trim();
				if (!txt) return [];
				return JSON.parse(txt);
			} catch (_) { return []; }
		}
		const labels = safeParse('countryLabels');
		const values = safeParse('countryValues');
		const ctx = document.getElementById('countryChart');
		if (!ctx) return;
		new Chart(ctx, {
			type: 'line',
			data: {
				labels,
				datasets: [{
					label: 'Freedom Index',
					data: values,
					borderColor: 'rgba(75, 192, 192, 1)',
					backgroundColor: 'rgba(75, 192, 192, 0.2)',
					tension: 0.2,
					fill: true
				}]
			},
			options: {
				responsive: true,
				plugins: {
					legend: { position: 'top' },
					title: { display: true, text: 'Freedom Index Over Time' }
				},
				scales: {
					y: { beginAtZero: true }
				}
			}
		});
	})();
	</script>
	</body>
</html>
